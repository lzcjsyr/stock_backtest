# 开发规范

## 基本行为准则

- 完整阅读代码，杜绝偷懒
- 不确定信息必须询问，确认后执行
- 解决方案精简，避免冗余代码

## 量化策略开发框架

### 策略必要要素清单

**重要：开发策略前必须收集完整信息，信息不完备时禁止开始编码**

用户要求开发策略时，必须逐项确认以下6个核心要素：

**1. 选择范围** 📊

- 股票池定义（全A股、沪深300、中证500、创业板等）
- 市值范围限制（大盘股、中盘股、小盘股）
- 行业限制或偏好

**2. 筛选指标** 🔍

- 主要筛选指标（PE、PB、ROE、净利润增长率、毛利率等）
- 具体阈值参数（如PE<20、ROE>15%等）
- 指标优先级或综合评分方式

**3. 选股数量** 📈

- 目标持仓股票数量（如10只、20只、50只等）
- 单只股票最大权重限制
- 行业集中度上限

**4. 权重分配** ⚖️

- 权重分配方式（等权重、市值加权、因子加权、风险平价等）
- 权重调整规则

**5. 调仓周期** 🔄

- 选股频率（月度、季度、半年度等）
- 具体调仓时间点（月末最后一个交易日、季度末等）
- 最小调仓幅度（避免频繁微调）

**6. 风险控制** 🛡️

- 最大回撤控制目标
- 换手率控制上限
- 手续费率设置

### 开发流程（严格执行）

1. **信息收集**：逐项检查上述6个核心要素，缺失信息必须向用户询问，不得跳过
2. **策略确认**：完整输出策略描述，等待用户明确确认后才能开始编码
3. **代码实现**：关键策略参数暴露在main函数输入参数中，每个参数必须包含详细说明（参数含义、取值范围、默认值等）
4. **测试验证**：确保策略逻辑正确，参数调节功能正常

### 参数暴露要求

**重要：所有可调节的数值参数必须在main函数中暴露，禁止硬编码在策略内部**

必须暴露的参数类型：

- **数量参数**：选股数量、最大持仓数等
- **价格参数**：最低股价、最高股价等
- **比率参数**：PE阈值、PB阈值、ROE阈值、负债率上限等
- **权重参数**：单股最大权重、行业集中度上限等
- **时间参数**：调仓周期天数、回看天数等

**参数定义标准**：

```python
def run_backtest(
    stock_count: int = 20,           # 选股数量，范围：5-100，默认20
    min_price: float = 5.0,          # 最低股价，范围：1-50，默认5元
    max_pe: float = 30.0,            # PE上限，范围：10-100，默认30
    min_roe: float = 0.15,           # ROE下限，范围：0.05-0.5，默认15%
    max_debt_ratio: float = 0.6,     # 负债率上限，范围：0.2-0.8，默认60%
    rebalance_days: int = 30         # 调仓周期（天），范围：7-365，默认30天
):
    """
    策略回测主函数
  
    Parameters:
    -----------
    stock_count : int
        选股数量，决定持仓股票的数量
    min_price : float  
        最低股价过滤，低于此价格的股票被排除
    max_pe : float
        市盈率上限，高于此值的股票被排除
    min_roe : float
        净资产收益率下限，低于此值的股票被排除
    max_debt_ratio : float
        资产负债率上限，高于此值的股票被排除
    rebalance_days : int
        调仓周期，每隔多少天进行一次调仓
    """
```

**禁止事项**：

- 禁止在代码内部写死数值（如 `if pe < 20:`）
- 禁止使用无说明的魔法数字
- 禁止参数缺少注释和取值范围

### 策略参数展示设计

**设计理念**：在策略代码文件末尾提供清晰的参数配置区，让用户无需深入代码逻辑即可轻松调整关键参数。

**实现要求**：

```python
if __name__ == "__main__":
    # ==================== 策略参数设置 ====================
    # 基本策略参数
    MIN_MARKET_CAP = 100.0      # 最低市值要求(亿元) - 范围：50-500
    STOCK_COUNT = 10            # 选股数量 - 范围：5-30
    TRANSACTION_COST = 0.0001   # 交易手续费率
  
    # 回测时间范围 (精确到日期)
    START_DATE = "2020-01-01"   # 回测开始日期 - 格式：YYYY-MM-DD
    END_DATE = "2025-06-30"     # 回测结束日期 - 格式：YYYY-MM-DD
  
    # 不同资金规模建议
    # 2-5万元：STOCK_COUNT = 3-5,  MIN_MARKET_CAP = 50
    # 5-10万元：STOCK_COUNT = 5-8,  MIN_MARKET_CAP = 100  
    # 10-20万元：STOCK_COUNT = 10,   MIN_MARKET_CAP = 100 (推荐)
    # 20万元+：STOCK_COUNT = 15-20, MIN_MARKET_CAP = 150
  
    # 友好的参数显示和策略运行
    print("📈 策略名称")
    print(f"📊 当前参数: 参数详情...")
    print(f"💡 建议资金规模: XX万元以上")
  
    # 运行策略
    run_backtest(参数...)
```

**设计优势**：

- 一目了然：关键参数集中在文件末尾
- 易于修改：只需改变几个变量值
- 参数说明：每个参数都有注释和建议范围
- 资金匹配：不同资金规模的具体建议
- 时间精确：支持精确到日期的回测时间设置

### 信息缺失提醒模板

当用户提出策略需求但信息不完整时，按以下模板逐项询问：

```
您的策略还需要明确以下信息：

□ 选择范围：从哪个股票池选股？（全A股/沪深300/中证500等）
□ 筛选指标：用什么指标筛选？具体阈值是多少？
□ 选股数量：持仓多少只股票？
□ 权重分配：如何分配权重？（等权重/市值加权等）
□ 调仓周期：多久调仓一次？具体时间点？
□ 风险控制：最大回撤限制？手续费率？

请补充缺失的信息。
```

### 策略开发常见问题

#### 1. 财报数据滞后性问题

进行回测时，要注意财报数据发布的滞后性，不要开上帝视角。

**解决方案**：

- 根据当前月份选择已披露的财报期：
  - 11-12月：可以使用当年Q3数据
  - 8-10月：可以使用当年中报数据
  - 5-7月：可以使用当年Q1数据
  - 1-4月：可以使用上年Q3数据

#### 2. 交易日判断问题

要注意不是每个自然日都是交易日。有的策略需要考虑是否是交易日。

**解决方案**：

- 从股票行情数据中获取实际交易日期列表
- 月末调仓时使用实际的月末交易日

## 回测输出格式规范

### 1. 文件结构要求

```
results/
└── [策略名称_MMDD_HHMM]/
    ├── backtest_results.xlsx     # 详细数据表格
    ├── net_value_chart.png       # 净值走势图
    └── README.md                 # 回测报告文档
```

### 2. Excel文件内容 (backtest_results.xlsx)

- **策略概览工作表 (Strategy_Overview)**
  - 策略名称和详细描述
  - 关键参数设置及说明
  - 回测时间范围
  - 核心业绩指标汇总
  - 策略逻辑简介
- **选股详情工作表 (Stock_Selection)**
  - 期数、调仓日期
  - 股票代码、股票名称
  - 关键指标数据（价格、技术指标等）
  - 选股得分/排名
  - 期间涨跌幅表现

### 3. 净值走势图内容 (net_value_chart.png)

- **图表信息**
  - 净值曲线走势
- **图表标注信息**
  - 策略名称和简介
  - 关键参数设置
  - 回测起止日期
  - 最终收益率、最大回撤
  - 年化收益率、夏普比率等

### 4. 报告文档格式 (README.md)

```
第X期 (YYYY-MM-DD)
├── 选股清单
│   ├── 股票1: 代码 + 名称 + 关键数据
│   ├── 股票2: 代码 + 名称 + 关键数据
│   └── ...
├── 期间表现
│   ├── 期初净值: X.XX
│   ├── 期末净值: X.XX
│   ├── 净值涨跌幅: +X.XX%
│   └── 累计收益率: +X.XX%
└── 图表展示
```

### 5. 命名规范

- 文件夹：`[策略名称]_MMDD_HHMM` （如：动量选股_0307_1425）
- 确保每次回测都有独立的结果文件夹
- 便于不同策略和时间的回测结果管理

## 策略画图方法

### 技术栈：HTML + Chart.js + Playwright

使用HTML模板生成 + 无头浏览器截图的现代化画图方案。

### 核心实现

#### 1. 三个关键方法

```python
def generate_chart(self, result_dir):
    """主入口：生成策略图表"""
    try:
        self._generate_html_chart(result_dir)
    except Exception as e:
        print(f"❌ 图表生成失败: {e}")

def create_html_template(self, nav_data, params, js_paths=None):
    """生成HTML模板，包含图表配置和样式"""
    dates = [item['date'] for item in nav_data]
    values = [item['nav'] for item in nav_data]
    # Y轴范围：y_min = max(0.5, min_val - 0.2)
    # 数据格式：json.dumps() 转换为JS格式

def _screenshot_with_playwright(self, html_path, output_path):
    """浏览器截图生成PNG"""
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()
        page.set_viewport_size({"width": 1600, "height": 900})
        page.goto(f"file://{html_path}")
        page.wait_for_function("window.chartReady === true")
        page.screenshot(path=output_path, full_page=True)
```

#### 2. 关键配置

```javascript
// Chart.js配置要点
- annotation插件：添加1.0基准线
- 智能X轴标签：显示7个关键时间点
- 响应式设计：自适应不同尺寸
- 参数面板：网格布局展示策略信息
```

#### 3. 依赖和资源

```bash
pip install playwright
playwright install chromium

# 本地JS文件路径（优先）
assets/js/chart.umd.js
assets/js/chartjs-adapter-date-fns.bundle.min.js
assets/js/chartjs-plugin-annotation.min.js

# 备用CDN（网络环境）
```

### 通用适配要点

- **数据格式**：`nav_history = [{'date': 'YYYY-MM-DD', 'nav': float}]`
- **参数面板**：根据策略修改分组内容
- **色彩主题**：调整CSS渐变和配色方案
- **临时文件**：使用try/finally确保清理
- **集成方式**：在 `generate_reports()`中调用
